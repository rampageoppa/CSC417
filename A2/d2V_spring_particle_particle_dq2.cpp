#include <d2V_spring_particle_particle_dq2.h>

void d2V_spring_particle_particle_dq2(Eigen::Ref<Eigen::Matrix66d> H, Eigen::Ref<const Eigen::Vector3d> q0,  Eigen::Ref<const Eigen::Vector3d> q1, double l0, double stiffness) {

    double norm = sqrt(pow(q0[0] - q1[0], 2.0) + pow(q0[1] - q1[1], 2.0) + pow(q0[2] - q1[2], 2.0));

    double x_diff = q0[0] - q1[0];
    double y_diff = q0[1] - q1[1];
    double z_diff = q0[2] - q1[2];

    double s = stiffness;

    H(0, 0) = s * (l0 - norm) / norm - (s * pow(2.0 * x_diff, 2.0)) / (pow(x_diff, 2.0) * 4.0 + pow(y_diff, 2.0) * 4.0 + pow(z_diff, 2.0) * 4.0) - (s * pow(2.0 * x_diff, 2.0) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(0, 1) = s * (2.0 * x_diff) * (2.0 * y_diff) * (-1.0 / 4.0) / (pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0)) - (s * (2.0 * x_diff) * (2.0 * y_diff) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(0, 2) = s * (2.0 * x_diff) * (2.0 * z_diff) * (-1.0 / 4.0) / (pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0)) - (s * (2.0 * x_diff) * (2.0 * z_diff) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(0, 3) = -s * (l0 - norm) / norm + (s * pow(2.0 * x_diff, 2.0)) / (pow(x_diff, 2.0) * 4.0 + pow(y_diff, 2.0) * 4.0 + pow(z_diff, 2.0) * 4.0) + (s * pow(2.0 * x_diff, 2.0) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(0, 4) = s * (2.0 * x_diff) * (2.0 * y_diff) / (pow(x_diff, 2.0) * 4.0 + pow(y_diff, 2.0) * 4.0 + pow(z_diff, 2.0) * 4.0) + (s * (2.0 * x_diff) * (2.0 * y_diff) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(0, 5) = s * (2.0 * x_diff) * (2.0 * z_diff) / (pow(x_diff, 2.0) * 4.0 + pow(y_diff, 2.0) * 4.0 + pow(z_diff, 2.0) * 4.0) + (s * (2.0 * x_diff) * (2.0 * z_diff) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(1, 0) = s * (2.0 * x_diff) * (2.0 * y_diff) * (-1.0 / 4.0) / (pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0)) - (s * (2.0 * x_diff) * (2.0 * y_diff) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(1, 1) = s * (l0 - norm) / norm - (s * pow(2.0 * y_diff, 2.0)) / (pow(x_diff, 2.0) * 4.0 + pow(y_diff, 2.0) * 4.0 + pow(z_diff, 2.0) * 4.0) - (s * pow(2.0 * y_diff, 2.0) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(1, 2) = s * (2.0 * y_diff) * (2.0 * z_diff) * (-1.0 / 4.0) / (pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0)) - (s * (2.0 * y_diff) * (2.0 * z_diff) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(1, 3) = s * (2.0 * x_diff) * (2.0 * y_diff) / (pow(x_diff, 2.0) * 4.0 + pow(y_diff, 2.0) * 4.0 + pow(z_diff, 2.0) * 4.0) + (s * (2.0 * x_diff) * (2.0 * y_diff) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(1, 4) = -s * (l0 - norm) / norm + (s * pow(2.0 * y_diff, 2.0)) / (pow(x_diff, 2.0) * 4.0 + pow(y_diff, 2.0) * 4.0 + pow(z_diff, 2.0) * 4.0) + (s * pow(2.0 * y_diff, 2.0) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(1, 5) = s * (2.0 * y_diff) * (2.0 * z_diff) / (pow(x_diff, 2.0) * 4.0 + pow(y_diff, 2.0) * 4.0 + pow(z_diff, 2.0) * 4.0) + (s * (2.0 * y_diff) * (2.0 * z_diff) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(2, 0) = s * (2.0 * x_diff) * (2.0 * z_diff) * (-1.0 / 4.0) / (pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0)) - (s * (2.0 * x_diff) * (2.0 * z_diff) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(2, 1) = s * (2.0 * y_diff) * (2.0 * z_diff) * (-1.0 / 4.0) / (pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0)) - (s * (2.0 * y_diff) * (2.0 * z_diff) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(2, 2) = s * (l0 - norm) / norm - (s * pow(2.0 * z_diff, 2.0)) / (pow(x_diff, 2.0) * 4.0 + pow(y_diff, 2.0) * 4.0 + pow(z_diff, 2.0) * 4.0) - (s * pow(2.0 * z_diff, 2.0) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(2, 3) = s * (2.0 * x_diff) * (2.0 * z_diff) / (pow(x_diff, 2.0) * 4.0 + pow(y_diff, 2.0) * 4.0 + pow(z_diff, 2.0) * 4.0) + (s * (2.0 * x_diff) * (2.0 * z_diff) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(2, 4) = s * (2.0 * y_diff) * (2.0 * z_diff) / (pow(x_diff, 2.0) * 4.0 + pow(y_diff, 2.0) * 4.0 + pow(z_diff, 2.0) * 4.0) + (s * (2.0 * y_diff) * (2.0 * z_diff) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(2, 5) = -s * (l0 - norm) / norm + (s * pow(2.0 * z_diff, 2.0)) / (pow(x_diff, 2.0) * 4.0 + pow(y_diff, 2.0) * 4.0 + pow(z_diff, 2.0) * 4.0) + (s * pow(2.0 * z_diff, 2.0) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(3, 0) = -s * (l0 - norm) / norm + (s * pow(2.0 * x_diff, 2.0)) / (pow(x_diff, 2.0) * 4.0 + pow(y_diff, 2.0) * 4.0 + pow(z_diff, 2.0) * 4.0) + (s * pow(2.0 * x_diff, 2.0) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(3, 1) = s * (2.0 * x_diff) * (2.0 * y_diff) / (pow(x_diff, 2.0) * 4.0 + pow(y_diff, 2.0) * 4.0 + pow(z_diff, 2.0) * 4.0) + (s * (2.0 * x_diff) * (2.0 * y_diff) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(3, 2) = s * (2.0 * x_diff) * (2.0 * z_diff) / (pow(x_diff, 2.0) * 4.0 + pow(y_diff, 2.0) * 4.0 + pow(z_diff, 2.0) * 4.0) + (s * (2.0 * x_diff) * (2.0 * z_diff) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(3, 3) = s * (l0 - norm) / norm - (s * pow(2.0 * x_diff, 2.0)) / (pow(x_diff, 2.0) * 4.0 + pow(y_diff, 2.0) * 4.0 + pow(z_diff, 2.0) * 4.0) - (s * pow(2.0 * x_diff, 2.0) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(3, 4) = s * (2.0 * x_diff) * (2.0 * y_diff) * (-1.0 / 4.0) / (pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0)) - (s * (2.0 * x_diff) * (2.0 * y_diff) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(3, 5) = s * (2.0 * x_diff) * (2.0 * z_diff) * (-1.0 / 4.0) / (pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0)) - (s * (2.0 * x_diff) * (2.0 * z_diff) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(4, 0) = s * (2.0 * x_diff) * (2.0 * y_diff) / (pow(x_diff, 2.0) * 4.0 + pow(y_diff, 2.0) * 4.0 + pow(z_diff, 2.0) * 4.0) + (s * (2.0 * x_diff) * (2.0 * y_diff) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(4, 1) = -s * (l0 - norm) / norm + (s * pow(2.0 * y_diff, 2.0)) / (pow(x_diff, 2.0) * 4.0 + pow(y_diff, 2.0) * 4.0 + pow(z_diff, 2.0) * 4.0) + (s * pow(2.0 * y_diff, 2.0) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(4, 2) = s * (2.0 * y_diff) * (2.0 * z_diff) / (pow(x_diff, 2.0) * 4.0 + pow(y_diff, 2.0) * 4.0 + pow(z_diff, 2.0) * 4.0) + (s * (2.0 * y_diff) * (2.0 * z_diff) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(4, 3) = s * (2.0 * x_diff) * (2.0 * y_diff) * (-1.0 / 4.0) / (pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0)) - (s * (2.0 * x_diff) * (2.0 * y_diff) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(4, 4) = s * (l0 - norm) / norm - (s * pow(2.0 * y_diff, 2.0)) / (pow(x_diff, 2.0) * 4.0 + pow(y_diff, 2.0) * 4.0 + pow(z_diff, 2.0) * 4.0) - (s * pow(2.0 * y_diff, 2.0) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(4, 5) = s * (2.0 * y_diff) * (2.0 * z_diff) * (-1.0 / 4.0) / (pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0)) - (s * (2.0 * y_diff) * (2.0 * z_diff) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(5, 0) = s * (2.0 * x_diff) * (2.0 * z_diff) / (pow(x_diff, 2.0) * 4.0 + pow(y_diff, 2.0) * 4.0 + pow(z_diff, 2.0) * 4.0) + (s * (2.0 * x_diff) * (2.0 * z_diff) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(5, 1) = s * (2.0 * y_diff) * (2.0 * z_diff) / (pow(x_diff, 2.0) * 4.0 + pow(y_diff, 2.0) * 4.0 + pow(z_diff, 2.0) * 4.0) + (s * (2.0 * y_diff) * (2.0 * z_diff) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(5, 2) = -s * (l0 - norm) / norm + (s * pow(2.0 * z_diff, 2.0)) / (pow(x_diff, 2.0) * 4.0 + pow(y_diff, 2.0) * 4.0 + pow(z_diff, 2.0) * 4.0) + (s * pow(2.0 * z_diff, 2.0) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(5, 3) = s * (2.0 * x_diff) * (2.0 * z_diff) * (-1.0 / 4.0) / (pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0)) - (s * (2.0 * x_diff) * (2.0 * z_diff) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(5, 4) = s * (2.0 * y_diff) * (2.0 * z_diff) * (-1.0 / 4.0) / (pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0)) - (s * (2.0 * y_diff) * (2.0 * z_diff) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    H(5, 5) = s * (l0 - norm) / norm - (s * pow(2.0 * z_diff, 2.0)) / (pow(x_diff, 2.0) * 4.0 + pow(y_diff, 2.0) * 4.0 + pow(z_diff, 2.0) * 4.0) - (s * pow(2.0 * z_diff, 2.0) * (l0 - norm) * 1.0 / pow(pow(x_diff, 2.0) + pow(y_diff, 2.0) + pow(z_diff, 2.0), 3.0 / 2.0)) / 4.0;
    
}
